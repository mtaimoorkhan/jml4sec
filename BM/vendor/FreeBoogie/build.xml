<!-- ANT build script by rgrig. -->
<project name="FreeBoogie" default="dist" basedir=".">
  <description>
    infrastructure for handling BoogiePL
  </description>

  <!-- set global properties for this build -->
  <property name="debug" value="yes" />
  <property name="src" location="src" />
  <property name="build" location="classes" />
  <property name="dist" location="dist" />
  <property name="doc" location="doc" />
  <property name="version" value="0.0"/>
  <property name="ast" location="src/freeboogie/ast" />
  <property name="astgen" location="src/freeboogie/ast/gen" />
  <property name="parser" location="src/freeboogie/parser" />
  <path id="classpath"><fileset dir="lib" includes="*.jar" /></path>

  <!-- AST generation -->
  <target name="compile_astgen" description="compile freeboogie.ast">
    <mkdir dir="${build}" />
    <javac srcdir="${src}" destdir="${build}"
      deprecation="yes" optimize="yes" debug="${debug}"
      includes="freeboogie/ast/gen/*.java"
    />
  </target>

  <target name="generate_ast" depends="clean_ast,compile_astgen" 
    description="generates AST">
    <java fork="yes" dir="${ast}" classpath="${build}"
      classname="freeboogie.ast.gen.Main">
      <arg value="fb.ag" />
      <arg value="abstract_classes.tpl" />
      <arg value="normal_classes.tpl" />
      <arg value="evaluator.tpl" />
      <arg value="transformer.tpl" />
      <arg value="html.tpl" />
      <arg value="list.tpl" />
    </java>
    <exec dir="${ast}" executable="dot">
      <arg value="-Tgif" />
      <arg value="hierarchy.dot" />
      <arg value="-o" />
      <arg value="hierarchy.gif" />
    </exec>
  </target>

  <!-- Parser generation (using ANTLR) -->
  <target name="generate_parser">
    <java fork="yes" dir="${parser}" classname="org.antlr.Tool">
      <classpath refid="classpath" />
      <arg value="Fb.g" />
    </java>
  </target>

  <!-- Compile and distribution targets -->
  <target name="compile" depends="generate_ast,generate_parser"
    description="compile the source ">
    <javac srcdir="${src}" destdir="${build}" 
           deprecation="yes" optimize="yes" debug="${debug}">
      <classpath refid="classpath" /> 
    </javac>
  </target>
  
  <target name="doc" description="generate javadoc" 
    depends="generate_ast,generate_parser">
    <javadoc destdir="${doc}" sourcepath="${src}">
      <package name="freeboogie.*" />
      <classpath refid="classpath" />
    </javadoc>
  </target>

  <target name="dist" depends="compile" description="generate the distribution">
    <mkdir dir="${dist}/lib" />
    <jar jarfile="${dist}/lib/freeboogie-${version}.jar" basedir="${build}" />
  </target>
  
  
  <!-- Test targets -->
  <target name="unit_test" depends="compile" description="run unit tests">
    <!-- TODO: Write unit tests. -->
  </target>
  
  <target name="functional_test" depends="compile" description="run functional tests">
    <exec executable="test/functional/test" dir="test/functional" resolveexecutable="true" />
  </target>
  
  <target name="test" depends="unit_test, functional_test" description="run all tests"></target>

  <!-- Cleanup targets -->
  <target name="clean_ast" description="removes AST generated files">
    <delete>
      <fileset dir="${ast}" includesfile="${ast}/generated.list"/>
    </delete>
  </target>

  <target name="clean" depends="clean_ast" description="clean up">
    <delete dir="${build}" />
    <delete dir="${dist}" />
    <delete dir="${doc}" />
    <delete>
      <!-- ANTLR generated files -->
      <fileset dir="src/freeboogie/parser" includes="FbParser.java" />
      <fileset dir="src/freeboogie/parser" includes="FbLexer.java" />
      <fileset dir="src/freeboogie/parser" includes="Fb.tokens" />
      <fileset dir="src/freeboogie/parser" includes="*.gl" />
    </delete>
    <delete>
      <!-- files generated by testing -->
      <fileset dir="test/functional" includes="**/diff.*" />
      <fileset dir="test/functional" includes="**/out" />
      <fileset dir="test/functional" includes="**/err" />
      <fileset dir="test/functional" includes="**/*.log" />
    </delete>
    <defaultexcludes remove="**/*~" />
    <delete>
      <!-- editor leftovers -->
      <fileset dir="" includes="**/*~"/>
      <fileset dir="" includes="**/semantic.cache" />
    </delete>
    <delete>
      <!-- TeX leftovers -->
      <fileset dir="" includes="**/*.aux" />
      <fileset dir="" includes="**/*.log" />
    </delete>
    <defaultexcludes default="true" />
  </target>
</project>

